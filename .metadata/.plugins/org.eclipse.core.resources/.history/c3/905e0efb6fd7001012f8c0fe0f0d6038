package com.project.mediverse.controller;

import java.time.LocalDate;
import java.util.List;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;

import com.project.mediverse.entity.Credential;
import com.project.mediverse.entity.Customer;
import com.project.mediverse.entity.InsuranceClaim;
import com.project.mediverse.entity.Medicine;
import com.project.mediverse.entity.Order;
import com.project.mediverse.service.CustomerService;
import com.project.mediverse.service.MedicineService;
import com.project.mediverse.service.OrderService;
import com.project.mediverse.service.PaymentService;

@Controller
@RequestMapping("/user")
public class CustomerController 
{
	@Autowired 
	private MedicineService medicineService;
	@Autowired 
	OrderService orderService;
	@Autowired
	PaymentService paymentService;
	@Autowired
	CustomerService customerService;
	@Autowired
	InsuranceClaim insuranceClaimService;
	@GetMapping("/home")
    public ModelAndView showHomePage() 
    {
        return new ModelAndView("UserHomePage");
    }
    @GetMapping("/invalid")
    public ModelAndView showInvalidPage() 
    {
        return new ModelAndView("InvalidPage");
    }
    @GetMapping("/profile")
    public ModelAndView showUserProfilePage()
    {
    	return new ModelAndView("UserProfilePage");
    }
    @GetMapping("/order")
    public ModelAndView showUserOrderPage()
    {
    	return new ModelAndView("UserOrderPage");
    }
    @GetMapping("/search")
    public ModelAndView searchMedicines(@RequestParam("searchQuery") String searchQuery, Model model) {
        List<Medicine> medicines = medicineService.searchMedicines(searchQuery);
        model.addAttribute("medicines", medicines);
        return new ModelAndView("MedicineSearchResultPage");
    }
    @GetMapping("/user/buyMedicine/{medicineId}")
    public String showBuyMedicinePage(@PathVariable Long medicineId, Model model) {
        // Fetch medicine details
        Medicine medicine = medicineService.getMedicineById(medicineId);
        if (medicine == null) {
            model.addAttribute("error", "Medicine not found");
            return "error";
        }
        model.addAttribute("medicine", medicine);
        return "buyMedicinePage";
    }

    // Handle the form submission from the Buy Medicine page
    @PostMapping("/user/submitBuyMedicine")
    public String submitBuyMedicine(
            @RequestParam Long medicineId,
            @RequestParam Long customerId,
            @RequestParam int quantity,
            @RequestParam String deliveryAddress,
            @RequestParam(required = false) Long insuranceClaimId,
            @RequestParam String paymentMethod,
            @RequestParam(required = false) String cardNumber,
            @RequestParam(required = false) String cardCvv,
            @RequestParam(required = false) String cardHolderName,
            @RequestParam(required = false) String cardExpiryMonth,
            @RequestParam(required = false) String cardExpiryYear,
            Model model) {

        // Validate if medicine exists
        Medicine medicine = medicineService.getMedicineById(medicineId);
        if (medicine == null) {
            model.addAttribute("error", "Medicine not found");
            return "error";
        }

        // Validate if customer exists
        Customer customer = customerService.getCustomerById(customerId);
        if (customer == null) {
            model.addAttribute("error", "Customer not found");
            return "error";
        }

        // Calculate total amount based on quantity and medicine price
        double totalAmount = medicine.getPrice() * quantity;

        // Handle insurance claim if provided
        InsuranceClaim insuranceClaim = null;
        if (insuranceClaimId != null) {
            insuranceClaim = insuranceClaimService.getInsuranceClaimById(insuranceClaimId);
            if (insuranceClaim == null) {
                model.addAttribute("error", "Invalid Insurance Claim ID");
                return "error";
            }
        }

        // Create the order
        Order order = new Order();
        order.setCustomer(customer);
        order.setMedicines(List.of(medicine));
        order.setQuantity(quantity);
        order.setTotalAmount(totalAmount);
        order.setPaymentStatus("Pending");
        order.setOrderedDate(LocalDate.now());
        order.setOrderStatus("Pending");
        order.setDeliveryAddress(deliveryAddress);
        order.setInsuranceClaim(insuranceClaim);
        
        // Save the order
        orderService.addOrder(order);

        // Process payment if Debit Card is selected
        if (paymentMethod.equals("Debit Card")) {
            if (cardNumber == null || cardCvv == null || cardHolderName == null || cardExpiryMonth == null || cardExpiryYear == null) {
                model.addAttribute("error", "Please provide all card details");
                return "error";
            }

            // Simulate card validation and charge
            boolean cardValid = paymentService.validateCard(cardNumber, cardCvv, cardExpiryMonth, cardExpiryYear, cardHolderName);
            if (!cardValid) {
                model.addAttribute("error", "Invalid card details");
                return "error";
            }

            // Create a payment entry
            Payment payment = new Payment();
            payment.setOrder(order);
            payment.setPaymentAmount(totalAmount);
            payment.setPaymentDate(LocalDate.now());
            payment.setPaymentMethod("Debit Card");
            payment.setPaymentStatus("Paid");

            paymentService.createPayment(payment);

            // Update order payment status
            order.setPaymentStatus("Paid");
            orderService.updateOrder(order);

            return "paymentSuccess"; // Redirect to a success page
        }

        // Handle Cash on Delivery
        if (paymentMethod.equals("Cash on Delivery")) {
            // Just set the order as pending for cash on delivery
            order.setPaymentStatus("Pending");
            orderService.updateOrder(order);
            return "paymentPending"; // Redirect to a pending payment page
        }

        model.addAttribute("error", "Invalid payment method");
        return "error";
    }
 
}
