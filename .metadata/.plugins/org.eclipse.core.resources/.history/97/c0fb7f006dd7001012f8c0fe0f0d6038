package com.project.mediverse.controller;

import java.util.List;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;

import com.project.mediverse.entity.Credential;
import com.project.mediverse.entity.Medicine;
import com.project.mediverse.entity.Order;
import com.project.mediverse.service.MedicineService;

@Controller
@RequestMapping("/user")
public class CustomerController 
{
	@Autowired 
	private MedicineService medicineService;
	@GetMapping("/home")
    public ModelAndView showHomePage() 
    {
        return new ModelAndView("UserHomePage");
    }
    @GetMapping("/invalid")
    public ModelAndView showInvalidPage() 
    {
        return new ModelAndView("InvalidPage");
    }
    @GetMapping("/profile")
    public ModelAndView showUserProfilePage()
    {
    	return new ModelAndView("UserProfilePage");
    }
    @GetMapping("/order")
    public ModelAndView showUserOrderPage()
    {
    	return new ModelAndView("UserOrderPage");
    }
    @GetMapping("/search")
    public ModelAndView searchMedicines(@RequestParam("searchQuery") String searchQuery, Model model) {
        List<Medicine> medicines = medicineService.searchMedicines(searchQuery);
        model.addAttribute("medicines", medicines);
        return new ModelAndView("MedicineSearchResultPage");
    }
    @GetMapping("/buyMedicine")
    public String showBuyMedicinePage(@RequestParam("medicineId") Long medicineId, Model model) {
        Medicine medicine = medicineService.getMedicineById(medicineId);
        model.addAttribute("medicine", medicine);
        return "BuyMedicinePage";
    }
    @PostMapping("/completePurchase")
    public String completePurchase(@ModelAttribute("order") @Valid Order order,
                                   BindingResult bindingResult,
                                   @RequestParam("quantity") int quantity,
                                   @RequestParam("address") String address,
                                   @RequestParam(value = "insuranceClaimId", required = false) String insuranceClaimId,
                                   @RequestParam("paymentMethod") String paymentMethod,
                                   @RequestParam(value = "cardNumber", required = false) String cardNumber,
                                   @RequestParam(value = "cvv", required = false) String cvv,
                                   Model model) {

        if (bindingResult.hasErrors()) {
            return "BuyMedicinePage";  // Return to the form if there are errors
        }

        // Step 2.1: Validate Quantity and Address
        if (quantity <= 0) {
            model.addAttribute("error", "Quantity must be greater than 0");
            return "BuyMedicinePage";
        }

        // Fetch Customer from Session or Database
        Customer customer = customerService.getLoggedInCustomer();  // Assuming this method exists
        
        // Step 2.2: Calculate Total Amount
        Medicine medicine = medicineService.findMedicineById(order.getMedicines().get(0).getMedicineId());
        double totalAmount = medicine.getPrice() * quantity;
        
        // Step 2.3: Save Order
        order.setCustomer(customer);
        order.setMedicines(order.getMedicines());
        order.setQuantity(quantity);
        order.setTotalAmount(totalAmount);
        order.setOrderedDate(LocalDate.now());
        order.setOrderStatus("Pending");
        orderService.saveOrder(order);

        // Step 2.4: Handle Payment
        if ("debitCard".equals(paymentMethod)) {
            // Validate Card Information
            boolean cardValid = paymentService.validateCard(cardNumber, cvv);
            if (!cardValid) {
                model.addAttribute("error", "Invalid card details.");
                return "BuyMedicinePage";
            }

            // Process Debit Card Payment
            boolean paymentSuccess = paymentService.processDebitCardPayment(order, cardNumber, cvv);
            if (!paymentSuccess) {
                model.addAttribute("error", "Payment failed. Please try again.");
                return "BuyMedicinePage";
            }
        } else if ("cashOnDelivery".equals(paymentMethod)) {
            // Handle Cash on Delivery
            order.setPaymentStatus("Pending");
            orderService.saveOrder(order);
        }

        // Step 2.5: Confirm the Order
        model.addAttribute("order", order);
        return "OrderConfirmationPage";
    }
 
}
